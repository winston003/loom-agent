# Feature Specification: ROI 计算工具

**Feature Branch**: `001-roi-tool`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 用户描述: "新增一个计算ROI的工具"

## Clarifications

### Session 2025-11-14

- Q: 该工具主要面向哪些场景（商业/产品、教学/演示、研发评估）？是否需要多模式支持与默认模式？ → A: 默认采用商业/产品模式，并支持通过参数切换到演示/研发模式。

## User Scenarios & Testing (mandatory)

### User Story 1 - 单笔 ROI 计算（Priority: P1）

作为业务分析师，我可以输入成本与收益，系统立即返回 ROI（比率与百分比）以及简短说明，便于复制到报告或继续计算。

**Why this priority**: 单笔计算是最核心的使用场景，覆盖 80% 的需求。

**Independent Test**: 仅凭该故事即可演示和验证（输入成本=100、收益=130，输出 ROI=0.30 与 30.00%）。

**Acceptance Scenarios**:

1. Given 成本=100、收益=130，When 发起计算，Then 返回 ROI 比率=0.30、百分比=30.00%、说明文本包含“投资回报率 30.00%”。
2. Given 成本=200、收益=180，When 发起计算，Then 返回 ROI 比率=-0.10、百分比=-10.00%、说明文本包含“亏损”。
3. Given 成本<=0 或 缺失任何必要字段，When 发起计算，Then 返回明确的校验错误，包含原因与修复指引（不返回数值结果）。

---

### User Story 2 - 批量 ROI 计算（Priority: P2）

作为财务人员，我可以一次性传入多笔成本/收益条目，系统逐条返回 ROI 及汇总统计（平均、最小、最大），用于初步分析。

**Why this priority**: 批量处理可显著提升效率，满足报表类需求。

**Independent Test**: 传入 3 条记录（(100,130)、(200,180)、(50,75)），可独立验证逐条结果与汇总统计。

**Acceptance Scenarios**:

1. Given 三条有效记录，When 发起批量计算，Then 每条均返回 ROI（比率与百分比），并附带汇总（平均/最小/最大 ROI）。
2. Given 含有无效记录（如成本为 0），When 发起批量计算，Then 对无效记录返回错误项且整体返回成功，不影响其他有效记录的结果与汇总（汇总仅基于有效项）。

---

### User Story 3 - 输出格式与可读性（Priority: P3）

作为报告撰写者，我可以选择结构化输出（用于系统对接）或可读文本（用于粘贴到文档），并可配置小数位数，确保结果一致与易用。

**Why this priority**: 提升可用性与集成友好度。

**Independent Test**: 在单笔与批量模式下分别选择文本/结构化输出与不同小数位数均可独立验证。

**Acceptance Scenarios**:

1. Given 单笔计算，When 选择文本输出，Then 返回自然语言描述，包含百分比与四舍五入规则一致的数值。
2. Given 批量计算，When 选择结构化输出，Then 返回包含每条结果与汇总字段的结构化对象，字段命名清晰一致。
3. Given 未显式指定模式，When 发起计算，Then 按“商业/产品”模式默认行为（结构化输出、严格校验、隐藏调试信息）。
4. Given 指定模式=“demo”或“r&d”，When 发起计算，Then 默认可读文本输出、校验更宽松且可附带解释性说明（但数值计算与四舍五入规则保持一致）。

---

### Edge Cases

- 成本为 0 或负数（必须提示错误，不计算）
- 收益为负数（允许，产生负 ROI）
- 大数值与小数精度（四舍五入一致、避免浮点表达歧义）
- 批量输入混合合法/不合法条目（必须部分成功、逐项报告错误）
- 缺失字段与类型错误（返回明确的校验信息）
- 模式参数非法或未知值（回退到“商业/产品”模式并返回非致命警告）

## Requirements (mandatory)

### Functional Requirements

- **FR-001**: 系统必须基于公式 ROI = (收益 - 成本) / 成本 进行计算。
- **FR-002**: 系统必须同时返回 ROI 比率（小数）与百分比（两位小数，四舍五入）。
- **FR-003**: 当成本缺失、等于 0 或为负数时，必须返回明确的校验错误（不返回数值结果）。
- **FR-004**: 当收益缺失或非数值时，必须返回明确的校验错误。
- **FR-005**: 系统必须提供两种输出：
  - 结构化输出（含字段：ratio、percentage、explanation；批量时含 results[] 与 summary）。
  - 可读文本输出（中文，简洁说明，单/批量均可）。
- **FR-006**: 小数处理规则：比率保留至 4 位小数（四舍五入）；百分比保留 2 位小数（四舍五入）。
- **FR-007**: 批量计算时，必须返回逐条结果与汇总统计（平均、最小、最大 ROI），汇总仅基于有效记录。
- **FR-008**: 对每个错误条目，必须返回错误原因与定位（行号/索引）。
- **FR-009**: 输入/输出必须与语言无关、货币无关（不涉及汇率与税费假设）。
- **FR-010**: 响应中不得包含实现细节或内部错误栈，仅返回对用户有意义的信息。
- **FR-011**: 支持 `mode` 参数：`product`（默认）、`demo`、`r&d`（别名 `dev`），大小写不敏感；未指定或非法时回退为 `product` 并返回非致命警告。
- **FR-012**: `product` 模式：默认结构化输出、严格输入校验（致命输入错误不产出数值结果）、稳定化四舍五入规则、隐藏调试/实验性字段。
- **FR-013**: `demo`/`r&d` 模式：默认可读文本输出、在不影响准确性的前提下更偏向提示与解释；允许附加解释性说明字段；聚合统计仅基于有效项。

### Key Entities (if data involved)

- **ROI 输入**：成本（必填，>0）、收益（必填，数值）。
- **ROI 结果**：比率（decimal）、百分比（string，含%）、可读说明（string）。
- **批量结果**：逐条结果列表、汇总统计（avg/min/max）。

## Success Criteria (mandatory)

### Measurable Outcomes

- **SC-001**: 单笔计算在 100ms 内完成（95% 分位，用户感知“即时”）。
- **SC-002**: 输入错误场景 100% 返回明确校验信息（覆盖成本=0/负数、缺失字段、类型错误）。
- **SC-003**: [User satisfaction metric, e.g., "90% of users successfully complete primary task on first attempt"]
- **SC-004**: [Business metric, e.g., "Reduce support tickets related to [X] by 50%"]
